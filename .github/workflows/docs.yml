name: Documentation

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Build documentation
      run: cargo doc --no-deps
    
    - name: Prepare docs directory
      run: |
        # Remove old docs directory if it exists
        rm -rf docs
        # Create docs directory
        mkdir -p docs
        # Copy generated documentation
        cp -r target/doc/* docs/
        # Create a redirect index.html at root that points to the crate docs
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=runecast_protocol/index.html">
            <title>Redirecting to runecast_protocol documentation</title>
        </head>
        <body>
            <p>Redirecting to <a href="runecast_protocol/index.html">runecast_protocol documentation</a>...</p>
        </body>
        </html>
        EOF
        # Create .nojekyll to prevent GitHub Pages from ignoring files starting with underscore
        touch docs/.nojekyll
    
    - name: Commit and push documentation
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add docs/
        git diff --staged --quiet || git commit -m "Update documentation"
        git push
